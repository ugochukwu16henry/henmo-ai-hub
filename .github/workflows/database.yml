name: Database Operations

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Database action'
        required: true
        default: 'migrate'
        type: choice
        options:
          - migrate
          - rollback
          - seed
          - backup

jobs:
  database-ops:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: cd apps/api && npm ci
        
      - name: Run migration
        if: github.event.inputs.action == 'migrate'
        run: cd apps/api && npm run migrate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          
      - name: Run rollback
        if: github.event.inputs.action == 'rollback'
        run: cd apps/api && npm run migrate:rollback
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          
      - name: Run seed
        if: github.event.inputs.action == 'seed'
        run: cd apps/api && npm run seed
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          
      - name: Create backup
        if: github.event.inputs.action == 'backup'
        run: |
          pg_dump ${{ secrets.DATABASE_URL }} > backup-$(date +%Y%m%d-%H%M%S).sql
          echo "Backup created successfully"